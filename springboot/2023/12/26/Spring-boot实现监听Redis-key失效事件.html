<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<title>SpringBoot实现监听Redis key失效事件</title>
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>SpringBoot实现监听Redis key失效事件 | YoungLee’s Land</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="SpringBoot实现监听Redis key失效事件" />
<meta name="author" content="Shiayanga" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
<meta property="og:site_name" content="YoungLee’s Land" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-12-26T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="SpringBoot实现监听Redis key失效事件" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Shiayanga"},"dateModified":"2023-12-26T00:00:00+00:00","datePublished":"2023-12-26T00:00:00+00:00","description":"Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.","headline":"SpringBoot实现监听Redis key失效事件","mainEntityOfPage":{"@type":"WebPage","@id":"/springboot/2023/12/26/Spring-boot%E5%AE%9E%E7%8E%B0%E7%9B%91%E5%90%ACRedis-key%E5%A4%B1%E6%95%88%E4%BA%8B%E4%BB%B6.html"},"url":"/springboot/2023/12/26/Spring-boot%E5%AE%9E%E7%8E%B0%E7%9B%91%E5%90%ACRedis-key%E5%A4%B1%E6%95%88%E4%BA%8B%E4%BB%B6.html"}</script>
<!-- End Jekyll SEO tag -->


<script type="text/javascript" src="/assets/js/darkmode.js"></script>

</head><body>
  <main class="container">
    <section class="about">
      <div class="about-header condensed">
      <div class="about-title">
      <a href="/">
        
        <img src="/assets/WechatIMG52.jpg" alt="Young Lee" />
        
      </a>
      <h2 id="title">
        <a href="/">Young Lee</a>
      </h2>
      </div><p class="tagline">Developer. Designer</p></div>
      
      <ul class="social about-footer condensed"><a href="https://github.com/shiayanga" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2020 - 2025</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/springboot/2023/12/26/Spring-boot%E5%AE%9E%E7%8E%B0%E7%9B%91%E5%90%ACRedis-key%E5%A4%B1%E6%95%88%E4%BA%8B%E4%BB%B6.html">
    <h2 class="post-title">SpringBoot实现监听Redis key失效事件</h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Dec 26, 2023</div><ul class="post-categories"><li>SpringBoot</li></ul></div>
  <div class="post">
    <h1 id="一-开启redis-key过期提醒">一. 开启Redis key过期提醒</h1>
<ul>
  <li>
    <p>方式一：修改配置文件</p>

    <p><code class="language-plaintext highlighter-rouge">redis.conf</code></p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># 默认 notify-keyspace-events ""</span>
  notify-keyspace-events Ex
</code></pre></div>    </div>
  </li>
  <li>
    <p>方式二：命令行开启</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">CONFIG</span> <span class="k">SET</span> <span class="k">notify</span><span class="o">-</span><span class="n">keyspace</span><span class="o">-</span><span class="n">events</span> <span class="n">Ex</span>
  <span class="n">CONFIG</span> <span class="k">GET</span> <span class="k">notify</span><span class="o">-</span><span class="n">keyspace</span><span class="o">-</span><span class="n">events</span>
</code></pre></div>    </div>
  </li>
</ul>

<h1 id="二-notify-keyspace-events">二. notify-keyspace-events</h1>

<p><strong>notify-keyspace-events 选项的默认值为空</strong></p>

<p>notify-keyspace-events 的参数可以是以下字符的<strong>任意组合</strong>， 它指定了服务器该发送哪些类型的通知。</p>

<table>
  <thead>
    <tr>
      <th>字符</th>
      <th>发送的通知</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>K</td>
      <td>键空间通知，所有通知以 <strong>keyspace@</strong> 为前缀</td>
    </tr>
    <tr>
      <td>E</td>
      <td>键事件通知，所有通知以 <strong>keyevent@</strong> 为前缀</td>
    </tr>
    <tr>
      <td>g</td>
      <td>DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知</td>
    </tr>
    <tr>
      <td>$</td>
      <td>字符串命令的通知</td>
    </tr>
    <tr>
      <td>l</td>
      <td>列表命令的通知</td>
    </tr>
    <tr>
      <td>s</td>
      <td>集合命令的通知</td>
    </tr>
    <tr>
      <td>h</td>
      <td>哈希命令的通知</td>
    </tr>
    <tr>
      <td>z</td>
      <td>有序集合命令的通知</td>
    </tr>
    <tr>
      <td>x</td>
      <td>过期事件：每当有过期键被删除时发送</td>
    </tr>
    <tr>
      <td>e</td>
      <td>驱逐(evict)事件：每当有键因为 maxmemory 政策而被删除时发送</td>
    </tr>
    <tr>
      <td>A</td>
      <td>参数 g$lshzxe 的别名</td>
    </tr>
  </tbody>
</table>

<h1 id="三-coding">三. Coding</h1>

<ol>
  <li>初始化一个<code class="language-plaintext highlighter-rouge">Spring Boot</code>项目</li>
  <li><code class="language-plaintext highlighter-rouge">pom.xml</code>
    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;dependencies&gt;</span>
 		<span class="nt">&lt;dependency&gt;</span>
 			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
 			<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
 		<span class="nt">&lt;/dependency&gt;</span>
 		<span class="nt">&lt;dependency&gt;</span>
 			<span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
 			<span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
 		<span class="nt">&lt;/dependency&gt;</span>
 	<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>定义配置类`RedisListenerConfig
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Configuration</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisListenerConfig</span> <span class="o">{</span>
    
 	<span class="nd">@Bean</span>
 	<span class="nc">RedisMessageListenerContainer</span> <span class="nf">container</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
 		<span class="nc">RedisMessageListenerContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisMessageListenerContainer</span><span class="o">();</span>
 		<span class="n">container</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
 		<span class="k">return</span> <span class="n">container</span><span class="o">;</span>
 	<span class="o">}</span>
    
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>定义数据生产类<code class="language-plaintext highlighter-rouge">ProviderDataToRedis</code>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Slf4j</span>
 <span class="nd">@Component</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderDataToRedis</span> <span class="kd">implements</span> <span class="nc">CommandLineRunner</span> <span class="o">{</span>
    
 	<span class="nd">@Autowired</span>
 	<span class="kd">private</span> <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>
    
 	<span class="nd">@Override</span>
 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
 		<span class="kt">int</span><span class="o">[]</span> <span class="n">num</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span><span class="mi">1</span><span class="o">};</span>
 		<span class="nc">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
 		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
 			<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
 			<span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">max</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"mq:s1:%s"</span><span class="o">,</span> <span class="o">++</span><span class="n">num</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span> <span class="s">"已预订"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"放了 {} 条数据到redis..."</span><span class="o">,</span> <span class="n">max</span><span class="o">);</span>
 			<span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
 		<span class="o">}</span>
 	<span class="o">}</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>定义监听器 实现<code class="language-plaintext highlighter-rouge">KeyExpirationEventMessageListener</code>接口
查看源码发现，该接口监听所有db的过期事件<code class="language-plaintext highlighter-rouge">keyevent@*:expired"</code>
定义<code class="language-plaintext highlighter-rouge">Status1ExpirationListener</code>监听状态1到期
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Slf4j</span>
 <span class="nd">@Component</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Status1ExpirationListener</span> <span class="kd">extends</span> <span class="nc">KeyExpirationEventMessageListener</span> <span class="o">{</span>
    
 	<span class="kd">public</span> <span class="nf">Status1ExpirationListener</span><span class="o">(</span><span class="nc">RedisMessageListenerContainer</span> <span class="n">listenerContainer</span><span class="o">)</span> <span class="o">{</span>
 		<span class="kd">super</span><span class="o">(</span><span class="n">listenerContainer</span><span class="o">);</span>
 	<span class="o">}</span>
    
 	<span class="nd">@Autowired</span>
 	<span class="kd">private</span> <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>
    
 	<span class="nd">@Override</span>
 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">pattern</span><span class="o">)</span> <span class="o">{</span>
 		<span class="c1">// 用户做自己的业务处理即可,注意message.toString()可以获取失效的key</span>
 		<span class="nc">String</span> <span class="n">expiredKey</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
 		<span class="k">if</span> <span class="o">(</span><span class="n">expiredKey</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"mq:s1:"</span><span class="o">))</span> <span class="o">{</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-----------------------------------"</span><span class="o">);</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"过期key[%s]"</span><span class="o">,</span> <span class="n">expiredKey</span><span class="o">));</span>
 			<span class="nc">String</span> <span class="n">newKey</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"mq:s2:%s"</span><span class="o">,</span> <span class="n">expiredKey</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">6</span><span class="o">));</span>
 			<span class="nc">String</span> <span class="n">newValue</span> <span class="o">=</span> <span class="s">"行程中"</span><span class="o">;</span>
 			<span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">newKey</span><span class="o">,</span> <span class="n">newValue</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s: %s"</span><span class="o">,</span> <span class="n">newKey</span><span class="o">,</span> <span class="n">newValue</span><span class="o">));</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-----------------------------------"</span><span class="o">);</span>
 		<span class="o">}</span>
 	<span class="o">}</span>
    
 <span class="o">}</span>
</code></pre></div>    </div>

    <p>定义<code class="language-plaintext highlighter-rouge">Status2ExpirationListener</code>监听状态2到期</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Slf4j</span>
 <span class="nd">@Component</span>
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Status2ExpirationListener</span> <span class="kd">extends</span> <span class="nc">KeyExpirationEventMessageListener</span> <span class="o">{</span>
    
 	<span class="kd">public</span> <span class="nf">Status2ExpirationListener</span><span class="o">(</span><span class="nc">RedisMessageListenerContainer</span> <span class="n">listenerContainer</span><span class="o">)</span> <span class="o">{</span>
 		<span class="kd">super</span><span class="o">(</span><span class="n">listenerContainer</span><span class="o">);</span>
 	<span class="o">}</span>
    
 	<span class="nd">@Override</span>
 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">pattern</span><span class="o">)</span> <span class="o">{</span>
 		<span class="c1">// 用户做自己的业务处理即可,注意message.toString()可以获取失效的key</span>
 		<span class="nc">String</span> <span class="n">expiredKey</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
 		<span class="k">if</span> <span class="o">(</span><span class="n">expiredKey</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"mq:s2:"</span><span class="o">))</span> <span class="o">{</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"***********************************"</span><span class="o">);</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"过期key[%s]"</span><span class="o">,</span> <span class="n">expiredKey</span><span class="o">));</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[{}]行程已完成，修改数据库状态。"</span><span class="o">,</span> <span class="n">newKey</span><span class="o">);</span>
 			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"***********************************"</span><span class="o">);</span>
 		<span class="o">}</span>
 	<span class="o">}</span>
    
 <span class="o">}</span>
</code></pre></div>    </div>
    <h1 id="四-参考">四. 参考</h1>
    <p><a href="https://redis.io/docs/manual/keyspace-notifications/">Redis keyspace notifications</a></p>
  </li>
</ol>


  </div></div>

    </section>
    <footer class="condensed">
      <ul class="social about-footer condensed"><a href="https://github.com/shiayanga" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a></ul><p class="about-footer condensed">&copy;
        2020 - 2025</p><div class="about-footer condensed">
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" class="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
    </footer>
  </main>
  
  <script type="text/javascript" src="/assets/js/darkmode.js"></script>
  
</body>

</html>
